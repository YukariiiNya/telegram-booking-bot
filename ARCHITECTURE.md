# Архитектура системы

## Схема работы

```
┌─────────────┐
│   Клиент    │
│  (Telegram) │
└──────┬──────┘
       │
       │ 1. /start, номер телефона
       │ 5. Получает уведомления
       ↓
┌──────────────────────────────────────┐
│     Telegram Bot API                 │
│  (api.telegram.org)                  │
└──────────────┬───────────────────────┘
               │
               │ 2. Обработка команд
               │ 6. Отправка сообщений
               ↓
┌──────────────────────────────────────┐
│   Ваш сервер (Python приложение)     │
│                                      │
│  ┌────────────────────────────────┐  │
│  │  main.py                       │  │
│  │  - Запуск бота                 │  │
│  │  - Веб-сервер для вебхуков     │  │
│  └────────────────────────────────┘  │
│                                      │
│  ┌────────────────────────────────┐  │
│  │  handlers/                     │  │
│  │  - bot_handlers.py             │  │
│  │    (команды /start, рейтинг)   │  │
│  │  - webhook_handlers.py         │  │
│  │    (обработка вебхуков Bukza)  │  │
│  └────────────────────────────────┘  │
│                                      │
│  ┌────────────────────────────────┐  │
│  │  services/                     │  │
│  │  - scheduler.py                │  │
│  │    (планирование задач)        │  │
│  │  - bukza_client.py             │  │
│  │    (API Bukza, если есть)      │  │
│  └────────────────────────────────┘  │
│                                      │
│  ┌────────────────────────────────┐  │
│  │  database/                     │  │
│  │  - models.py (User, Booking)   │  │
│  │  - repository.py               │  │
│  └────────────────────────────────┘  │
└──────────┬───────────────┬───────────┘
           │               │
           │ 3. Сохранение │ 4. Получение
           │    данных     │    вебхуков
           ↓               ↓
    ┌─────────────┐  ┌──────────┐
    │ PostgreSQL  │  │  Bukza   │
    │   (БД)      │  │ (Вебхуки)│
    └─────────────┘  └──────────┘
```

## Поток данных

### 1. Регистрация клиента

```
Клиент → /start → Бот → Запрос номера телефона
                   ↓
Клиент → Номер → Бот → Сохранение в БД
                   ↓
              Подтверждение
```

### 2. Создание записи в Bukza

```
Клиент записывается → Bukza → Вебхук → Ваш сервер
                                           ↓
                                    Сохранение в БД
                                           ↓
                                    Отправка уведомления
                                           ↓
                                    Планирование:
                                    - Напоминание (за 24ч)
                                    - Запрос обратной связи
```

### 3. Напоминание (за 24 часа)

```
Планировщик → Проверка времени → Отправка напоминания
                                        ↓
                                 Клиент получает
                                 сообщение в Telegram
```

### 4. Запрос обратной связи

```
Планировщик → После времени записи → Запрос оценки
                                          ↓
Клиент → Оценка 1-5 → Бот → Сохранение в БД
                        ↓
                   Если 5 → Ссылки на отзывы
                   Если 1-4 → Благодарность
```

### 5. Отмена записи

```
Отмена в Bukza → Вебхук → Ваш сервер
                              ↓
                       Обновление статуса в БД
                              ↓
                       Отмена запланированных задач
                              ↓
                       Уведомление клиента
```

## Компоненты системы

### 1. Telegram Bot (aiogram)
- Обработка команд пользователей
- Отправка сообщений
- FSM (конечный автомат) для диалогов

### 2. Web Server (aiohttp)
- Прием вебхуков от Bukza
- REST endpoint: `/webhook/bukza`

### 3. Database (PostgreSQL + SQLAlchemy)
**Таблицы:**
- `users` - пользователи Telegram
- `bookings` - записи из Bukza
- `messages` - история отправленных сообщений

### 4. Scheduler (APScheduler)
- Планирование напоминаний
- Планирование запросов обратной связи
- Отмена задач при отмене записи

### 5. Bukza Integration
- Прием вебхуков (основной способ)
- API клиент (опционально, если доступен)

## Безопасность

### 1. Переменные окружения
Все секретные данные хранятся в `.env`:
- Токен бота
- Пароль БД
- API ключи

### 2. HTTPS
Обязательно для вебхуков:
- SSL-сертификат (Let's Encrypt)
- Nginx как reverse proxy

### 3. Валидация данных
- Проверка формата вебхуков
- Нормализация номеров телефонов
- Валидация пользовательского ввода

## Масштабирование

### Текущая архитектура
- Один сервер
- Один процесс Python
- Подходит для малого/среднего бизнеса

### Для роста нагрузки
1. **Горизонтальное масштабирование:**
   - Несколько инстансов бота
   - Load balancer (Nginx)
   - Shared PostgreSQL

2. **Оптимизация БД:**
   - Индексы на часто используемых полях
   - Connection pooling
   - Read replicas

3. **Кэширование:**
   - Redis для сессий
   - Кэш частых запросов

4. **Очередь задач:**
   - Celery для фоновых задач
   - RabbitMQ/Redis как брокер

## Мониторинг

### Логи
- Все действия логируются
- Уровни: INFO, WARNING, ERROR
- Ротация логов

### Метрики
- Количество активных пользователей
- Количество записей
- Количество отправленных сообщений
- Ошибки отправки

### Алерты
- Падение сервера
- Ошибки БД
- Проблемы с Telegram API
- Проблемы с вебхуками Bukza

## Резервное копирование

### База данных
```bash
# Ежедневный бэкап
pg_dump booking_bot > backup_$(date +%Y%m%d).sql

# Восстановление
psql booking_bot < backup_20250127.sql
```

### Конфигурация
- `.env` файл
- Nginx конфиг
- Systemd сервис

## Обновления

### Процесс обновления
1. Тестирование на dev окружении
2. Бэкап БД
3. `git pull`
4. Миграции БД (если есть)
5. Перезапуск сервиса
6. Проверка логов

### Откат
1. Восстановление БД из бэкапа
2. `git checkout` на предыдущую версию
3. Перезапуск сервиса
