# Документ требований

## Введение

Telegram-бот для автоматизации коммуникации с клиентами салона красоты. Система получает данные о записях через вебхуки от Bukza и отправляет автоматические уведомления клиентам в Telegram на разных этапах взаимодействия: при создании записи, отмене, напоминании за день до визита и запросе обратной связи после посещения.

## Глоссарий

- **Telegram-бот**: автоматизированное приложение в мессенджере Telegram для взаимодействия с клиентами
- **Bukza**: система онлайн-бронирования и управления записями клиентов салона
- **Вебхук**: HTTP-запрос, который Bukza отправляет боту при определенных событиях
- **Запись**: бронирование клиентом услуги на определенное время
- **Клиент**: пользователь, который записывается на услуги через Yclients
- **База данных**: хранилище информации о пользователях, записях и сообщениях
- **Оценка услуг**: числовая оценка от 1 до 5, которую клиент ставит после посещения
- **2ГИС**: сервис карт и отзывов
- **Яндекс.Карты**: сервис карт и отзывов от Яндекс

## Требования

### Требование 1

**Пользовательская история:** Как клиент, я хочу получать уведомление в Telegram при создании записи, чтобы иметь подтверждение моего бронирования.

#### Критерии приемки

1. WHEN Bukza отправляет вебхук о создании записи, THEN Telegram-бот SHALL отправить клиенту сообщение с деталями записи (дата, время, услуга)
2. WHEN клиент еще не связан с Telegram-ботом, THEN Telegram-бот SHALL сохранить информацию о записи в базе данных для последующей отправки
3. WHEN сообщение о записи отправлено, THEN Telegram-бот SHALL сохранить запись об отправленном сообщении в базе данных
4. WHEN вебхук содержит некорректные данные, THEN Telegram-бот SHALL логировать ошибку и не отправлять сообщение клиенту

### Требование 2

**Пользовательская история:** Как клиент, я хочу получать уведомление в Telegram при отмене записи, чтобы знать, что моя запись больше не активна.

#### Критерии приемки

1. WHEN Bukza отправляет вебхук об отмене записи, THEN Telegram-бот SHALL отправить клиенту сообщение об отмене записи
2. WHEN запись отменена, THEN Telegram-бот SHALL удалить запланированное напоминание для этой записи
3. WHEN сообщение об отмене отправлено, THEN Telegram-бот SHALL обновить статус записи в базе данных
4. WHEN клиент не связан с ботом, THEN Telegram-бот SHALL обновить статус записи в базе данных без отправки сообщения

### Требование 3

**Пользовательская история:** Как клиент, я хочу получать напоминание за один день до записи, чтобы не забыть о предстоящем визите.

#### Критерии приемки

1. WHEN наступает время за 24 часа до записи, THEN Telegram-бот SHALL отправить клиенту напоминание с деталями записи
2. WHEN запись была отменена, THEN Telegram-бот SHALL не отправлять напоминание
3. WHEN напоминание отправлено, THEN Telegram-бот SHALL сохранить запись об отправленном напоминании в базе данных
4. WHEN клиент не связан с ботом, THEN Telegram-бот SHALL пропустить отправку напоминания

### Требование 4

**Пользовательская история:** Как владелец салона, я хочу собирать обратную связь от клиентов после посещения, чтобы улучшать качество услуг.

#### Критерии приемки

1. WHEN наступает время записи плюс длительность услуги, THEN Telegram-бот SHALL отправить клиенту сообщение с просьбой оценить услугу от 1 до 5
2. WHEN клиент отправляет число от 1 до 5, THEN Telegram-бот SHALL сохранить оценку в базе данных
3. WHEN клиент отправляет оценку 5, THEN Telegram-бот SHALL отправить сообщение со ссылками на 2ГИС и Яндекс.Карты
4. WHEN клиент отправляет оценку от 1 до 4, THEN Telegram-бот SHALL поблагодарить клиента за обратную связь
5. WHEN клиент отправляет некорректный ответ, THEN Telegram-бот SHALL повторно попросить оценить услугу числом от 1 до 5

### Требование 5

**Пользовательская история:** Как администратор системы, я хочу хранить всю информацию о клиентах и записях в базе данных, чтобы иметь полную историю взаимодействий.

#### Критерии приемки

1. WHEN новый клиент начинает взаимодействие с ботом, THEN Telegram-бот SHALL создать запись о пользователе в базе данных с Telegram ID
2. WHEN приходит вебхук о записи, THEN Telegram-бот SHALL сохранить данные записи (ID записи, ID клиента, дата, время, услуга, статус)
3. WHEN бот отправляет сообщение, THEN Telegram-бот SHALL сохранить информацию о сообщении (тип, время отправки, ID записи)
4. WHEN клиент ставит оценку, THEN Telegram-бот SHALL сохранить оценку с привязкой к записи
5. WHEN происходит запрос к базе данных, THEN Telegram-бот SHALL использовать асинхронные операции для предотвращения блокировки

### Требование 6

**Пользовательская история:** Как администратор системы, я хочу получать вебхуки от Bukza, чтобы бот мог реагировать на события в системе бронирования.

#### Критерии приемки

1. WHEN Bukza отправляет вебхук, THEN Telegram-бот SHALL принять HTTP POST запрос на специальный endpoint
2. WHEN вебхук получен, THEN Telegram-бот SHALL валидировать структуру данных вебхука
3. WHEN вебхук валиден, THEN Telegram-бот SHALL обработать событие асинхронно
4. WHEN вебхук обработан, THEN Telegram-бот SHALL вернуть HTTP статус 200
5. WHEN обработка вебхука завершилась ошибкой, THEN Telegram-бот SHALL логировать ошибку и вернуть HTTP статус 500

### Требование 7

**Пользовательская история:** Как клиент, я хочу связать свой Telegram аккаунт с записями в Bukza, чтобы получать уведомления.

#### Критерии приемки

1. WHEN клиент отправляет команду /start боту, THEN Telegram-бот SHALL запросить номер телефона для связи с Bukza
2. WHEN клиент предоставляет номер телефона, THEN Telegram-бот SHALL сохранить связь между Telegram ID и номером телефона в базе данных
3. WHEN связь установлена, THEN Telegram-бот SHALL отправить все ожидающие уведомления для этого клиента
4. WHEN клиент уже связан, THEN Telegram-бот SHALL сообщить об этом и показать информацию о предстоящих записях

### Требование 8

**Пользовательская история:** Как администратор системы, я хочу использовать асинхронную архитектуру, чтобы бот мог обрабатывать множество запросов одновременно без блокировок.

#### Критерии приемки

1. WHEN бот обрабатывает запросы, THEN Telegram-бот SHALL использовать aiogram для асинхронной работы с Telegram API
2. WHEN бот выполняет HTTP запросы, THEN Telegram-бот SHALL использовать aiohttp для асинхронных HTTP операций
3. WHEN бот работает с базой данных, THEN Telegram-бот SHALL использовать асинхронный драйвер базы данных
4. WHEN происходит планирование отложенных задач, THEN Telegram-бот SHALL использовать асинхронный планировщик задач

### Требование 9

**Пользовательская история:** Как администратор системы, я хочу иметь систему планирования задач, чтобы отправлять напоминания и запросы обратной связи в нужное время.

#### Критерии приемки

1. WHEN создается новая запись, THEN Telegram-бот SHALL запланировать задачу отправки напоминания за 24 часа до записи
2. WHEN создается новая запись, THEN Telegram-бот SHALL запланировать задачу отправки запроса обратной связи после времени записи
3. WHEN запись отменяется, THEN Telegram-бот SHALL отменить все запланированные задачи для этой записи
4. WHEN наступает время выполнения задачи, THEN Telegram-бот SHALL выполнить соответствующее действие асинхронно
5. WHEN задача выполнена, THEN Telegram-бот SHALL удалить её из планировщика

### Требование 10

**Пользовательская история:** Как администратор системы, я хочу синхронизировать данные между Telegram-ботом и Bukza, чтобы информация о записях и клиентах была актуальной в обеих системах.

#### Критерии приемки

1. WHEN бот получает вебхук от Bukza, THEN Telegram-бот SHALL обновить данные записи в локальной базе данных
2. WHEN клиент связывает Telegram аккаунт, THEN Telegram-бот SHALL запросить у Bukza API все активные записи для этого номера телефона
3. WHEN Bukza изменяет данные записи (время, услуга), THEN Telegram-бот SHALL получить вебхук и обновить информацию в базе данных
4. WHEN бот сохраняет оценку клиента, THEN Telegram-бот SHALL отправить данные обратной связи в Bukza через API
5. WHEN происходит рассинхронизация данных, THEN Telegram-бот SHALL логировать расхождения для ручной проверки
6. WHEN бот запускается, THEN Telegram-бот SHALL проверить актуальность запланированных задач с данными из Bukza
