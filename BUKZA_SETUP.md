# Настройка вебхуков Bukza для Telegram-бота

## Быстрая инструкция по заполнению формы

Когда вы открываете форму создания вебхука в Bukza, заполните поля следующим образом:

### Для новой записи:

| Поле | Значение |
|------|----------|
| **Название** | `Telegram - Новая запись` |
| **URL запроса** | `https://your-domain.com/webhook/bukza?message=newrega&phone=%2B7%20%28{phone}%29` |
| **Метод** | `POST` (выбрать из списка) |
| **Свои заголовки** | Не ставить галочку |

В поле "Тело запроса" вставьте JSON (см. ниже в разделе 3.1)

### Для отмены записи:

| Поле | Значение |
|------|----------|
| **Название** | `Telegram - Отмена записи` |
| **URL запроса** | `https://your-domain.com/webhook/bukza?message=cancel&phone=%2B7%20%28{phone}%29` |
| **Метод** | `POST` (выбрать из списка) |
| **Свои заголовки** | Не ставить галочку |

В поле "Тело запроса" вставьте JSON (см. ниже в разделе 3.2)

---

## Шаг 1: Подготовка сервера

### Почему нужен сервер?

Telegram Bot API не может напрямую принимать вебхуки от Bukza, потому что:
- Bukza отправляет данные в своем формате
- Telegram ожидает команды через Bot API
- Нужна логика обработки (база данных, планировщик задач)

Поэтому мы создаем **промежуточный сервер** (Python приложение), который:
1. Принимает вебхуки от Bukza
2. Сохраняет данные в базу
3. Отправляет сообщения клиентам через Telegram Bot API
4. Планирует напоминания и запросы обратной связи

### Варианты развертывания:

#### Вариант 1: VPS/Dedicated сервер (рекомендуется)
- Аренда VPS (например, Timeweb, Selectel, DigitalOcean)
- Стоимость: от 200₽/месяц
- Полный контроль над сервером

#### Вариант 2: Heroku (бесплатно/платно)
- Простое развертывание
- Автоматический SSL
- Ограничения на бесплатном плане

#### Вариант 3: Railway.app (бесплатно/платно)
- Современная платформа
- Простое развертывание из GitHub
- $5 бесплатно каждый месяц

#### Вариант 4: Локальный сервер + ngrok (для тестирования)
- Запуск на своем компьютере
- ngrok создает публичный URL
- Только для разработки, не для продакшена

### Требования к серверу:

1. **Публичный IP или домен** (например, `bot.mycompany.ru`)
2. **SSL-сертификат** (HTTPS обязателен для вебхуков)
3. **Python 3.11+**
4. **PostgreSQL** (или другая БД)
5. **Открытый порт** (обычно 80 для HTTP, 443 для HTTPS)

## Шаг 2: Получение Telegram Bot Token

1. Найдите [@BotFather](https://t.me/botfather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте токен и добавьте в `.env`:
```env
BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
```

## Шаг 3: Настройка вебхуков в Bukza

### 3.1 Вебхук для новых записей

В админ-панели Bukza создайте новый вебхук:

#### Заполнение формы:

**Название:**
```
Telegram - Новая запись
```

**URL запроса:**
```
https://your-domain.com/webhook/bukza?message=newrega&phone=%2B7%20%28{phone}%29
```
*Замените `your-domain.com` на ваш реальный домен*

**Метод:**
Выберите `POST` из выпадающего списка

**Свои заголовки:**
Оставьте пустым (галочку не ставить)

**Тело запроса (скопируйте полностью):**
```json
{
  "code": "{code}",
  "name": "{name}",
  "name_zone": "{name_zone}",
  "start": "{start}",
  "end": "{end}",
  "teh_end": "{teh_end}",
  "id_zakaz": "{id_zakaz}",
  "total_sum": "{total_sum}",
  "resource": "{resource}",
  "payed": "{payed}",
  "kolvo": "{kolvo}",
  "invoiceItems": [],
  "fields": []
}
```

### 3.2 Вебхук для отмены записей

#### Заполнение формы:

**Название:**
```
Telegram - Отмена записи
```

**URL запроса:**
```
https://your-domain.com/webhook/bukza?message=cancel&phone=%2B7%20%28{phone}%29
```
*Замените `your-domain.com` на ваш реальный домен*

**Метод:**
Выберите `POST` из выпадающего списка

**Свои заголовки:**
Оставьте пустым (галочку не ставить)

**Тело запроса (скопируйте полностью):**
```json
{
  "code": "{code}",
  "name": "{name}",
  "name_zone": "{name_zone}",
  "start": "{start}",
  "end": "{end}",
  "teh_end": "{teh_end}",
  "id_zakaz": "{id_zakaz}",
  "total_sum": "{total_sum}",
  "resource": "{resource}",
  "payed": "{payed}",
  "kolvo": "{kolvo}",
  "invoiceItems": [],
  "fields": []
}
```

## Шаг 4: Замена переменных Bukza

В URL и теле запроса Bukza автоматически заменит переменные:

| Переменная | Описание | Пример |
|------------|----------|--------|
| `{phone}` | Номер телефона клиента | `+79991234567` |
| `{code}` | Код записи | `C6UDS3` |
| `{name}` | Имя клиента | `Алина` |
| `{start}` | Время начала | `27.12.2025 12:00` |
| `{end}` | Время окончания | `27.12.2025 13:00` |
| `{resource}` | Название услуги/ресурса | `VR Арена` |
| `{id_zakaz}` | ID заказа | `9831520` |

## Шаг 5: Настройка ссылок на отзывы

В файле `.env` укажите ссылки на ваши страницы в 2ГИС и Яндекс.Картах:

```env
LINK_2GIS=https://2gis.ru/firm/70000001234567890
LINK_YANDEX_MAPS=https://yandex.ru/maps/org/your_salon/1234567890/
```

### Как найти ссылки:

**2ГИС:**
1. Найдите свою организацию на 2gis.ru
2. Скопируйте URL из адресной строки

**Яндекс.Карты:**
1. Найдите свою организацию на yandex.ru/maps
2. Скопируйте URL из адресной строки

## Шаг 6: Тестирование

1. Создайте тестовую запись в Bukza
2. Проверьте логи бота:
```bash
# Если запущен через systemd
journalctl -u telegram-bot -f

# Если запущен напрямую
# Логи будут в консоли
```

3. Убедитесь, что клиент получил уведомление в Telegram

## Возможные проблемы

### Вебхук не срабатывает

1. Проверьте, что URL доступен извне:
```bash
curl https://your-domain.com/webhook/bukza?message=test&phone=test
```

2. Проверьте SSL-сертификат:
```bash
curl -v https://your-domain.com
```

3. Проверьте логи Bukza (если доступны)

### Клиент не получает сообщения

1. Убедитесь, что клиент зарегистрирован в боте (отправил `/start` и номер телефона)
2. Проверьте, что номер телефона в Bukza совпадает с номером в боте
3. Проверьте логи бота на наличие ошибок

### Формат даты не распознается

Убедитесь, что Bukza отправляет дату в формате `DD.MM.YYYY HH:MM` (например, `27.12.2025 12:00`)

## Дополнительная информация

### API Bukza

На момент написания документации публичное API Bukza может быть ограничено. Бот работает в основном через вебхуки.

Если у вас есть доступ к API Bukza, вы можете:
1. Получить API ключ в админ-панели
2. Добавить его в `.env`:
```env
BUKZA_API_KEY=your_api_key_here
BUKZA_API_URL=https://api.bukza.com
```

### Поддержка

Если возникли проблемы:
1. Проверьте логи бота
2. Проверьте настройки вебхуков в Bukza
3. Убедитесь, что все переменные окружения заполнены правильно
